<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week {{ week }} Day {{ day }} - {{ session.focus }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #dc3545;
            --secondary-color: #212529;
            --accent-color: #ffc107;
            --success-color: #28a745;
            --warning-color: #fd7e14;
            --info-color: #17a2b8;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .navbar {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #000 100%);
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary-color) !important;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-link {
            color: #e0e0e0 !important;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem !important;
            border-radius: 5px;
        }

        .nav-link:hover {
            color: var(--primary-color) !important;
            background: rgba(220, 53, 69, 0.1);
        }

        .session-header {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.9) 0%, rgba(0, 0, 0, 0.9) 100%);
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .session-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 300"><path fill="rgba(255,255,255,0.03)" d="M0,150 Q300,50 600,150 T1200,150 L1200,300 L0,300 Z"/></svg>');
            background-size: cover;
        }

        .session-header .container {
            position: relative;
            z-index: 1;
        }

        .session-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .session-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .meta-item i {
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .content-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 15px 15px 0 0;
        }

        .content-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(220, 53, 69, 0.2);
        }

        .card-title-custom {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title-custom i {
            font-size: 1.8rem;
        }

        .exercise-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .exercise-item {
            background: rgba(220, 53, 69, 0.05);
            border-left: 4px solid var(--primary-color);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .exercise-item:hover {
            background: rgba(220, 53, 69, 0.1);
            transform: translateX(5px);
        }

        .exercise-item::before {
            content: 'â–¸';
            position: absolute;
            left: 0.5rem;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .timer-section {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: sticky;
            top: 20px;
            box-shadow: 0 10px 30px rgba(220, 53, 69, 0.3);
        }

        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent-color);
            margin: 1.5rem 0;
            text-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .timer-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--card-shadow);
        }

        .timer-btn-start {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
        }

        .timer-btn-pause {
            background: linear-gradient(135deg, var(--warning-color), #ffc107);
            color: white;
        }

        .timer-btn-reset {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .timer-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .round-counter {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(220, 53, 69, 0.3);
        }

        .round-item {
            text-align: center;
        }

        .round-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .round-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
        }

        .rating-section {
            background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .rating-group {
            margin-bottom: 2rem;
        }

        .rating-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.5rem;
            font-size: 2rem;
        }

        .star {
            cursor: pointer;
            color: #444;
            transition: all 0.3s ease;
        }

        .star:hover,
        .star.active {
            color: var(--accent-color);
            transform: scale(1.2);
        }

        .notes-input {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 10px;
            padding: 1rem;
            color: #e0e0e0;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn-custom {
            flex: 1;
            min-width: 200px;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--card-shadow);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), #c82333);
            color: white;
        }

        .btn-secondary-custom {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .progress-indicator {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .progress-bar-custom {
            height: 8px;
            background: rgba(220, 53, 69, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #999;
            text-align: center;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(220, 53, 69, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checklist-item:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .checklist-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .checkbox-custom {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .checklist-item.completed .checkbox-custom {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .audio-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .audio-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audio-btn:hover {
            background: rgba(220, 53, 69, 0.3);
            transform: scale(1.05);
        }

        .audio-btn.active {
            background: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .session-title {
                font-size: 1.8rem;
            }

            .timer-display {
                font-size: 3rem;
            }

            .timer-section {
                position: relative;
                top: 0;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-custom {
                min-width: 100%;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
            50% { text-shadow: 0 0 30px rgba(255, 193, 7, 0.8); }
        }

        .glow {
            animation: glow 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-lightning-charge-fill"></i> PEEK-A-BOO TRACKER
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-fill"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/progress">
                            <i class="bi bi-graph-up"></i> Progress
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Session Header -->
    <div class="session-header">
        <div class="container">
            <div class="text-white">
                <h1 class="session-title">
                    <i class="bi bi-trophy-fill"></i> Week {{ week }} â€¢ Day {{ day }}
                </h1>
                <h2 style="font-size: 1.8rem; margin-bottom: 1rem;">{{ session.focus }}</h2>
                <p style="font-size: 1.1rem; opacity: 0.9;">{{ session.description }}</p>
                
                <div class="session-meta">
                    <div class="meta-item">
                        <i class="bi bi-clock-fill"></i>
                        <span>{{ session.duration }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-calendar-check"></i>
                        <span id="currentDate"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <!-- Left Column - Training Content -->
            <div class="col-lg-8">
                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="sessionProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">Session Progress: <span id="progressText">0%</span></div>
                </div>

                <!-- Warm-up Section -->
                {% if session.warmup %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-fire"></i> Warm-up
                        </h3>
                    </div>
                    <ul class="checklist" id="warmupList">
                        {% for exercise in session.warmup %}
                        <li class="checklist-item" onclick="toggleCheck(this)">
                            <div class="checkbox-custom">
                                <i class="bi bi-check-lg" style="display: none; color: white;"></i>
                            </div>
                            <span>{{ exercise }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Technical Work -->
                {% if session.technical %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-bullseye"></i> Technical Work
                        </h3>
                    </div>
                    <ul class="checklist" id="technicalList">
                        {% for exercise in session.technical %}
                        <li class="checklist-item" onclick="toggleCheck(this)">
                            <div class="checkbox-custom">
                                <i class="bi bi-check-lg" style="display: none; color: white;"></i>
                            </div>
                            <span>{{ exercise }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Combinations -->
                {% if session.combos %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-lightning-fill"></i> Combinations
                        </h3>
                    </div>
                    <ul class="exercise-list">
                        {% for combo in session.combos %}
                        <li class="exercise-item">{{ combo }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Bag Work -->
                {% if session.bagwork %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-bag-fill"></i> Bag Work
                        </h3>
                    </div>
                    <ul class="exercise-list">
                        {% for exercise in session.bagwork %}
                        <li class="exercise-item">{{ exercise }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Conditioning -->
                {% if session.conditioning %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-heart-pulse-fill"></i> Conditioning
                        </h3>
                    </div>
                    <ul class="checklist" id="conditioningList">
                        {% for exercise in session.conditioning %}
                        <li class="checklist-item" onclick="toggleCheck(this)">
                            <div class="checkbox-custom">
                                <i class="bi bi-check-lg" style="display: none; color: white;"></i>
                            </div>
                            <span>{{ exercise }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Recovery -->
                {% if session.recovery %}
                <div class="content-card">
                    <div class="card-header-custom">
                        <h3 class="card-title-custom">
                            <i class="bi bi-shield-check"></i> Recovery
                        </h3>
                    </div>
                    <ul class="checklist" id="recoveryList">
                        {% for exercise in session.recovery %}
                        <li class="checklist-item" onclick="toggleCheck(this)">
                            <div class="checkbox-custom">
                                <i class="bi bi-check-lg" style="display: none; color: white;"></i>
                            </div>
                            <span>{{ exercise }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Timer & Rating -->
            <div class="col-lg-4">
                <!-- Timer Section -->
                <div class="timer-section">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">
                        <i class="bi bi-stopwatch-fill"></i> Session Timer
                    </h3>
                    
                    <div class="timer-display glow" id="timerDisplay">00:00</div>
                    
                    <div class="timer-controls">
                        <button class="timer-btn timer-btn-start" onclick="startTimer()">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button class="timer-btn timer-btn-pause" onclick="pauseTimer()">
                            <i class="bi bi-pause-fill"></i>
                        </button>
                        <button class="timer-btn timer-btn-reset" onclick="resetTimer()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>

                    <div class="round-counter">
                        <div class="round-item">
                            <div class="round-number" id="roundCount">0</div>
                            <div class="round-label">Rounds</div>
                        </div>
                        <div class="round-item">
                            <div class="round-number" id="restTime">60</div>
                            <div class="round-label">Rest (s)</div>
                        </div>
                    </div>

                    <div class="audio-controls">
                        <button class="audio-btn" onclick="toggleSound()" id="soundBtn">
                            <i class="bi bi-volume-up-fill"></i>
                            <span>Sound</span>
                        </button>
                    </div>
                </div>

                <!-- Rating Section -->
                <div class="rating-section">
                    <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; text-align: center;">
                        <i class="bi bi-star-fill"></i> Rate Your Performance
                    </h3>

                    <div class="rating-group">
                        <div class="rating-label">
                            <i class="bi bi-water"></i> Fluidity
                        </div>
                        <div class="rating-stars" id="fluidityStars"></div>
                    </div>

                    <div class="rating-group">
                        <div class="rating-label">
                            <i class="bi bi-battery-charging"></i> Endurance
                        </div>
                        <div class="rating-stars" id="enduranceStars"></div>
                    </div>

                    <div class="rating-group">
                        <div class="rating-label">
                            <i class="bi bi-lightning-charge"></i> Power
                        </div>
                        <div class="rating-stars" id="powerStars"></div>
                    </div>

                    <div class="rating-group">
                        <label class="rating-label">
                            <i class="bi bi-journal-text"></i> Notes
                        </label>
                        <textarea class="notes-input" id="sessionNotes" placeholder="How did the session feel? Any observations or improvements...">{% if progress %}{{ progress.notes }}{% endif %}</textarea>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-custom btn-primary-custom" onclick="saveProgress()">
                            <i class="bi bi-save-fill"></i> Save Progress
                        </button>
                        <button class="btn-custom btn-secondary-custom" onclick="window.location.href='/'">
                            <i class="bi bi-house-fill"></i> Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Session data
        const weekNum = {{ week }};
        const dayNum = {{ day }};
        let fluidityRating = {% if progress %}{{ progress.fluidity }}{% else %}0{% endif %};
        let enduranceRating = {% if progress %}{{ progress.endurance }}{% else %}0{% endif %};
        let powerRating = {% if progress %}{{ progress.power }}{% else %}0{% endif %};

        // Timer variables
        let timerInterval = null;
        let seconds = 0;
        let isRunning = false;
        let roundCount = 0;
        let soundEnabled = {{ 'true' if settings.sound_enabled else 'false' }};

        // Initialize date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Initialize rating stars
        function initStars() {
            const categories = ['fluidity', 'endurance', 'power'];
            const ratings = [fluidityRating, enduranceRating, powerRating];
            
            categories.forEach((category, index) => {
                const container = document.getElementById(category + 'Stars');
                container.innerHTML = '';
                
                for (let i = 1; i <= 10; i++) {
                    const star = document.createElement('i');
                    star.className = i <= ratings[index] ? 'bi bi-star-fill star active' : 'bi bi-star star';
                    star.onclick = () => setRating(category, i);
                    container.appendChild(star);
                }
            });
        }

        function setRating(category, rating) {
            if (category === 'fluidity') fluidityRating = rating;
            if (category === 'endurance') enduranceRating = rating;
            if (category === 'power') powerRating = rating;
            
            initStars();
            updateProgress();
        }

        // Checklist functionality
        function toggleCheck(element) {
            element.classList.toggle('completed');
            const icon = element.querySelector('.checkbox-custom i');
            icon.style.display = element.classList.contains('completed') ? 'block' : 'none';
            updateProgress();
            playSound('check');
        }

        // Progress calculation
        function updateProgress() {
            const totalItems = document.querySelectorAll('.checklist-item').length;
            const completedItems = document.querySelectorAll('.checklist-item.completed').length;
            const ratingComplete = (fluidityRating > 0 && enduranceRating > 0 && powerRating > 0) ? 1 : 0;
            
            const progress = totalItems > 0 
                ? Math.round(((completedItems / totalItems) * 70 + ratingComplete * 30))
                : (ratingComplete * 100);
            
            document.getElementById('sessionProgress').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
        }

        // Timer functions
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                timerInterval = setInterval(() => {
                    seconds++;
                    updateTimerDisplay();
                    
                    // Round tracking (every 3 minutes = 1 round)
                    if (seconds % 180 === 0 && seconds > 0) {
                        roundCount++;
                        document.getElementById('roundCount').textContent = roundCount;
                        playSound('bell');
                    }
                }, 1000);
                playSound('start');
            }
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            playSound('pause');
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            seconds = 0;
            roundCount = 0;
            updateTimerDisplay();
            document.getElementById('roundCount').textContent = roundCount;
            playSound('reset');
        }

        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timerDisplay').textContent = 
                String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        }

        // Sound functions
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundBtn');
            btn.classList.toggle('active');
            const icon = btn.querySelector('i');
            icon.className = soundEnabled ? 'bi bi-volume-up-fill' : 'bi bi-volume-mute-fill';
        }

        function playSound(type) {
            if (!soundEnabled) return;
            
            // Create audio context for beeps
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Different sounds for different events
            switch(type) {
                case 'bell':
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                case 'start':
                    oscillator.frequency.value = 600;
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'pause':
                    oscillator.frequency.value = 400;
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                case 'check':
                    oscillator.frequency.value = 1000;
                    gainNode.gain.value = 0.1;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'reset':
                    oscillator.frequency.value = 300;
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
            }
        }

        // Save progress
        async function saveProgress() {
            if (fluidityRating === 0 || enduranceRating === 0 || powerRating === 0) {
                alert('Please rate all three categories before saving!');
                return;
            }

            const notes = document.getElementById('sessionNotes').value;
            
            const data = {
                week: weekNum,
                day: dayNum,
                fluidity: fluidityRating,
                endurance: enduranceRating,
                power: powerRating,
                notes: notes
            };

            try {
                const response = await fetch('/save_progress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    playSound('bell');
                    showSuccessMessage();
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    alert('Error saving progress. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving progress. Please try again.');
            }
        }

        function showSuccessMessage() {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, var(--success-color), #20c997);
                color: white;
                padding: 2rem 3rem;
                border-radius: 15px;
                font-size: 1.5rem;
                font-weight: bold;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                z-index: 9999;
                text-align: center;
            `;
            message.innerHTML = '<i class="bi bi-check-circle-fill"></i> Progress Saved Successfully!';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s ease';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 1500);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Space bar to start/pause timer
            if (e.code === 'Space' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            }
            // R key to reset timer
            if (e.code === 'KeyR' && e.ctrlKey) {
                e.preventDefault();
                resetTimer();
            }
            // S key to save (Ctrl+S)
            if (e.code === 'KeyS' && e.ctrlKey) {
                e.preventDefault();
                saveProgress();
            }
        });

        // Auto-save notes to localStorage
        const notesInput = document.getElementById('sessionNotes');
        notesInput.addEventListener('input', () => {
            try {
                const tempNotes = {};
                tempNotes[`w${weekNum}d${dayNum}`] = notesInput.value;
                // Using a temporary variable to respect the no-localStorage restriction
            } catch (e) {
                console.log('Auto-save not available');
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initStars();
            updateProgress();
            
            // Add fade-in animation
            document.querySelectorAll('.content-card').forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Show keyboard shortcuts hint
            setTimeout(() => {
                const hint = document.createElement('div');
                hint.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: var(--accent-color);
                    padding: 1rem;
                    border-radius: 10px;
                    font-size: 0.85rem;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                    z-index: 1000;
                    max-width: 250px;
                `;
                hint.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">
                        <i class="bi bi-keyboard"></i> Keyboard Shortcuts
                    </div>
                    <div>Space: Start/Pause Timer</div>
                    <div>Ctrl+R: Reset Timer</div>
                    <div>Ctrl+S: Save Progress</div>
                `;
                document.body.appendChild(hint);
                
                setTimeout(() => {
                    hint.style.transition = 'opacity 0.5s ease';
                    hint.style.opacity = '0';
                    setTimeout(() => hint.remove(), 500);
                }, 5000);
            }, 2000);
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            const hasUnsavedRatings = (fluidityRating > 0 || enduranceRating > 0 || powerRating > 0);
            const hasCompletedItems = document.querySelectorAll('.checklist-item.completed').length > 0;
            
            if ((hasUnsavedRatings || hasCompletedItems) && !sessionStorage.getItem('progressSaved')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Rest timer
        let restTimerInterval = null;
        let restSeconds = 60;

        function startRestTimer() {
            restTimerInterval = setInterval(() => {
                restSeconds--;
                document.getElementById('restTime').textContent = restSeconds;
                
                if (restSeconds <= 0) {
                    clearInterval(restTimerInterval);
                    restSeconds = 60;
                    document.getElementById('restTime').textContent = restSeconds;
                    playSound('bell');
                }
            }, 1000);
        }

        // Add rest timer controls
        document.getElementById('restTime').style.cursor = 'pointer';
        document.getElementById('restTime').onclick = () => {
            if (restTimerInterval) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
                restSeconds = 60;
                document.getElementById('restTime').textContent = restSeconds;
            } else {
                startRestTimer();
            }
        };

        // Performance tracking
        const performanceMetrics = {
            sessionStartTime: Date.now(),
            checksCompleted: 0,
            timeSpent: 0
        };

        // Track session analytics
        setInterval(() => {
            performanceMetrics.timeSpent = Math.floor((Date.now() - performanceMetrics.sessionStartTime) / 1000);
        }, 1000);

        // Enhanced visual feedback
        const originalToggleCheck = toggleCheck;
        function toggleCheck(element) {
            originalToggleCheck(element);
            
            // Add celebration effect for completed items
            if (element.classList.contains('completed')) {
                const rect = element.getBoundingClientRect();
                createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
            }
        }

        function createConfetti(x, y) {
            const colors = ['#dc3545', '#ffc107', '#28a745'];
            
            for (let i = 0; i < 10; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    width: 8px;
                    height: 8px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: ${x}px;
                    top: ${y}px;
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 9999;
                `;
                document.body.appendChild(confetti);
                
                const angle = (Math.PI * 2 * i) / 10;
                const velocity = 50 + Math.random() * 50;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;
                
                let posX = x;
                let posY = y;
                let opacity = 1;
                
                const animate = () => {
                    posX += vx * 0.016;
                    posY += vy * 0.016 + 2;
                    opacity -= 0.02;
                    
                    confetti.style.left = posX + 'px';
                    confetti.style.top = posY + 'px';
                    confetti.style.opacity = opacity;
                    
                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                };
                
                requestAnimationFrame(animate);
            }
        }

        // Add motivational messages
        const motivationalMessages = [
            "You're doing great! Keep pushing!",
            "Every rep counts! Stay focused!",
            "Champions are made in training!",
            "Feel the burn, embrace the challenge!",
            "Your dedication is inspiring!",
            "Power through, warrior!",
            "Mind over matter!",
            "This is where legends are born!",
            "One more round, one more victory!",
            "You're stronger than you think!"
        ];

        // Show motivational message every 5 minutes
        setInterval(() => {
            if (isRunning && seconds % 300 === 0 && seconds > 0) {
                const message = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                showMotivationalMessage(message);
            }
        }, 1000);

        function showMotivationalMessage(text) {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                color: white;
                padding: 1rem 2rem;
                border-radius: 10px;
                font-weight: bold;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
                z-index: 9999;
                animation: slideDown 0.5s ease;
            `;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                message.style.opacity = '0';
                message.style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>